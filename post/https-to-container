+++
title = "Прокидываем протокол клиента в исполняемый скрипт для веб-сервера"
summary = "Узнаём, по какому протоколу подключается клиент к серверу"
date = 2018-06-07
draft = false

# Tags and categories
# For example, use `tags = []` for no tags, or the form `tags = ["A Tag", "Another Tag"]` for one or more tags.
tags = ["QA", "CI"]

+++

Иногда приложению нужно знать, по какому протоколу соединяется Клиент.
Но при этом приложение скрыто за балансировщиком (SSL терминируется на балансировщике, апстримы работают по `HTTP`).

Суть в следующем - подменить параметр HTTPS информацией с балансировщика.

Тогда конфигруация балансировщика может быть
```
server {
    listen 80;
    rewrite ^(.*)$ https://$server_name$1 permanent;
}

server {
    listen 443;

    ssl on;
    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    location / {
        proxy_pass http://upstream.addr;
        proxy_set_header X-Forwarded-Proto $https;
        proxy_set_header Host $host;
    }
}
```

Конфигурация nginx на апстриме
```
server {
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ \.php$ {
        fastcgi_pass    unix:/var/run/php/php7.0-fpm.sock;
        include         fastcgi_params;
        fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param   HTTPS $http_x_forwarded_proto if_not_empty;
    }
}
```